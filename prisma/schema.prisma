generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id                String         @id @default(uuid())
    fullName          String
    email             String         @unique
    password          String?
    role              UserRole       @default(STUDENT)
    studentId         String?
    phone             String?
    bookings          Booking[]      @relation("UserBookings")
    validatedBookings Booking[]      @relation("ValidatedBy")
    approvedBookings  Booking[]      @relation("ApprovedBy")
    notifications     Notification[]
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt

    @@map("profiles")
}

model Room {
    id                  String    @id @default(uuid())
    name                String    @unique
    building            String
    floor               Int
    capacity            Int
    facilities          String[]  @default([])
    isAvailable         Boolean   @default(true)
    bookings            Booking[]
    alternativeBookings Booking[] @relation("AlternativeRoom")
    createdAt           DateTime  @default(now())
    updatedAt           DateTime  @updatedAt
}

model Booking {
    id                String        @id @default(uuid())
    user              User          @relation("UserBookings", fields: [userId], references: [id])
    userId            String
    room              Room          @relation(fields: [roomId], references: [id])
    roomId            String
    startTime         DateTime
    endTime           DateTime
    purpose           String
    eventName         String
    participantCount  Int
    letterFileUrl     String?
    status            BookingStatus @default(PENDING)
    adminNotes        String?
    wadirNotes        String?
    alternativeRoomId String?
    alternativeRoom   Room?         @relation("AlternativeRoom", fields: [alternativeRoomId], references: [id])
    validatedBy       User?         @relation("ValidatedBy", fields: [validatedById], references: [id])
    validatedById     String?
    validatedAt       DateTime?
    approvedBy        User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
    approvedById      String?
    approvedAt        DateTime?
    memos             Memo[]
    createdAt         DateTime      @default(now())
    updatedAt         DateTime      @updatedAt

    @@index([userId])
    @@index([roomId])
    @@index([status])
}

model Memo {
    id         String   @id @default(uuid())
    booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
    bookingId  String
    memoNumber String   @unique
    content    String
    issuedAt   DateTime
    createdAt  DateTime @default(now())
}

model Notification {
    id        String           @id @default(uuid())
    user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    String
    type      NotificationType
    title     String
    message   String
    link      String?
    isRead    Boolean          @default(false)
    readAt    DateTime?
    metadata  Json?
    createdAt DateTime         @default(now())
    updatedAt DateTime         @updatedAt

    @@index([userId, isRead])
    @@index([createdAt])
}

enum UserRole {
    STUDENT
    ADMIN
    WADIR3
}

enum BookingStatus {
    PENDING
    VALIDATED
    APPROVED
    REJECTED
}

enum NotificationType {
    NEW_BOOKING
    BOOKING_VALIDATED
    BOOKING_APPROVED
    BOOKING_REJECTED
    MEMO_READY
}
